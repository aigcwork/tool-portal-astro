---
import Layout from '../layouts/Layout.astro';
import type { NewsArticle } from '@/utils/newsManager';
import { getNewsArticles, createNewsArticle, updateNewsArticle, deleteNewsArticle } from '@/utils/newsManager';

const newsArticles: NewsArticle[] = getNewsArticles();

// Handle form submissions
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action');
  
  if (action === 'create') {
    const newArticle = {
      title: formData.get('title') as string,
      summary: formData.get('summary') as string,
      content: formData.get('content') as string,
      category: formData.get('category') as string,
      tags: (formData.get('tags') as string).split(',').map(tag => tag.trim()),
      date: formData.get('date') as string,
      readTime: formData.get('readTime') as string,
      featured: formData.get('featured') === 'true',
      image: formData.get('image') as string,
      author: {
        name: formData.get('authorName') as string,
        avatar: formData.get('authorAvatar') as string
      }
    };
    createNewsArticle(newArticle);
  } else if (action === 'update') {
    const id = parseInt(formData.get('id') as string);
    const updates = {
      title: formData.get('title') as string,
      summary: formData.get('summary') as string,
      content: formData.get('content') as string,
      category: formData.get('category') as string,
      tags: (formData.get('tags') as string).split(',').map(tag => tag.trim()),
      date: formData.get('date') as string,
      readTime: formData.get('readTime') as string,
      featured: formData.get('featured') === 'true',
      image: formData.get('image') as string,
      author: {
        name: formData.get('authorName') as string,
        avatar: formData.get('authorAvatar') as string
      }
    };
    updateNewsArticle(id, updates);
  } else if (action === 'delete') {
    const id = parseInt(formData.get('id') as string);
    deleteNewsArticle(id);
  }
}
---

<Layout title="èµ„è®¯ç®¡ç† - å·¥å…·ç½‘ç«™">
  <!-- Navigation Bar -->
  <nav class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center space-x-8">
          <div class="text-xl font-bold text-gray-900 dark:text-white">ç®¡ç†åå°</div>
          <div class="flex space-x-4">
            <a href="/admin/tools" class="text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 font-medium px-3 py-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
              ğŸ”§ å·¥å…·ç®¡ç†
            </a>
            <a href="/admin/news" class="text-blue-600 dark:text-blue-400 font-medium px-3 py-2 rounded-md bg-blue-50 dark:bg-blue-900/20">
              ğŸ“° èµ„è®¯ç®¡ç†
            </a>
            <a href="/admin/content" class="text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 font-medium px-3 py-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
              ğŸ“ˆ å†…å®¹ç®¡ç†
            </a>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <a href="/" target="_blank" class="text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400">
            ğŸŒ æŸ¥çœ‹ç½‘ç«™
          </a>
        </div>
      </div>
    </div>
  </nav>
  
  <main class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Header -->
    <section class="bg-gradient-to-br from-indigo-600 to-blue-700 text-white py-12">
      <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto text-center">
          <h1 class="text-3xl md:text-4xl font-bold mb-4">
            èµ„è®¯æ–‡ç« ç®¡ç†
          </h1>
          <p class="text-lg opacity-90">
            ç®¡ç†ç½‘ç«™èµ„è®¯æ–‡ç« ï¼Œæ”¯æŒå¢åˆ æ”¹æ“ä½œ
          </p>
        </div>
      </div>
    </section>

    <!-- Management Panel -->
    <section class="py-8">
      <div class="container mx-auto px-4">
        <div class="max-w-6xl mx-auto">
          <!-- Action Buttons -->
          <div class="flex flex-wrap gap-4 mb-8">
            <button 
              id="showCreateBtn"
              class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors"
            >
              â• æ–°å»ºæ–‡ç« 
            </button>
            <a 
              href="/news" 
              target="_blank"
              class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors inline-flex items-center"
            >
              ğŸŒ æŸ¥çœ‹å‰å°
            </a>
          </div>

          <!-- Create/Edit Form -->
          <div id="articleForm" class="hidden bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
              <span id="formTitle">æ–°å»ºæ–‡ç« </span>
            </h2>
            <form method="POST" class="space-y-4">
              <input type="hidden" name="action" id="formAction" value="create" />
              <input type="hidden" name="id" id="articleId" />
              
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    æ–‡ç« æ ‡é¢˜
                  </label>
                  <input 
                    type="text" 
                    name="title" 
                    id="title"
                    required
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                  />
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    æ–‡ç« åˆ†ç±»
                  </label>
                  <select 
                    name="category" 
                    id="category"
                    required
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                  >
                    <option value="äº§å“æ›´æ–°">äº§å“æ›´æ–°</option>
                    <option value="æ•°æ®ç»Ÿè®¡">æ•°æ®ç»Ÿè®¡</option>
                    <option value="å®‰å…¨å…¬å‘Š">å®‰å…¨å…¬å‘Š</option>
                    <option value="æŠ€æœ¯æ›´æ–°">æŠ€æœ¯æ›´æ–°</option>
                    <option value="ç¤¾åŒºæ´»åŠ¨">ç¤¾åŒºæ´»åŠ¨</option>
                  </select>
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  æ–‡ç« æ‘˜è¦
                </label>
                <textarea 
                  name="summary" 
                  id="summary"
                  rows="2"
                  required
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                ></textarea>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  æ–‡ç« å†…å®¹
                </label>
                <textarea 
                  name="content" 
                  id="content"
                  rows="6"
                  required
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                ></textarea>
              </div>
              
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    æ ‡ç­¾ (ç”¨é€—å·åˆ†éš”)
                  </label>
                  <input 
                    type="text" 
                    name="tags" 
                    id="tags"
                    placeholder="AI, æ¨èç³»ç»Ÿ, ä¸ªæ€§åŒ–"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                  />
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    é˜…è¯»æ—¶é—´
                  </label>
                  <input 
                    type="text" 
                    name="readTime" 
                    id="readTime"
                    placeholder="3åˆ†é’Ÿ"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                  />
                </div>
              </div>
              
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    å‘å¸ƒæ—¥æœŸ
                  </label>
                  <input 
                    type="date" 
                    name="date" 
                    id="date"
                    required
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                  />
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    ç‰¹è‰²æ–‡ç« 
                  </label>
                  <select 
                    name="featured" 
                    id="featured"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                  >
                    <option value="false">å¦</option>
                    <option value="true">æ˜¯</option>
                  </select>
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  æ–‡ç« å›¾ç‰‡URL
                </label>
                <input 
                  type="url" 
                  name="image" 
                  id="image"
                  placeholder="https://example.com/image.jpg"
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                />
              </div>
              
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    ä½œè€…å§“å
                  </label>
                  <input 
                    type="text" 
                    name="authorName" 
                    id="authorName"
                    required
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                  />
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    ä½œè€…å¤´åƒ
                  </label>
                  <input 
                    type="text" 
                    name="authorAvatar" 
                    id="authorAvatar"
                    placeholder="ğŸ‘¨â€ğŸ’»"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                  />
                </div>
              </div>
              
              <div class="flex gap-4 pt-4">
                <button 
                  type="submit"
                  class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors"
                >
                  ä¿å­˜æ–‡ç« 
                </button>
                <button 
                  type="button"
                  id="cancelArticleBtn"
                  class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors"
                >
                  å–æ¶ˆ
                </button>
              </div>
            </form>
          </div>

          <!-- Articles List -->
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
              <h2 class="text-xl font-bold text-gray-900 dark:text-white">
                æ–‡ç« åˆ—è¡¨ ({newsArticles.length})
              </h2>
            </div>
            
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50 dark:bg-gray-700">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                      ID
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                      æ ‡é¢˜
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                      åˆ†ç±»
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                      æ—¥æœŸ
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                      ç‰¹è‰²
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                      æ“ä½œ
                    </th>
                  </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                  {newsArticles.map((article) => (
                    <tr>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">
                        {article.id}
                      </td>
                      <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-100 max-w-xs truncate">
                        {article.title}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span class={`px-2 py-1 rounded-full text-xs font-medium ${
                          article.category === 'äº§å“æ›´æ–°' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' :
                          article.category === 'æ•°æ®ç»Ÿè®¡' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' :
                          article.category === 'å®‰å…¨å…¬å‘Š' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' :
                          article.category === 'æŠ€æœ¯æ›´æ–°' ? 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200' :
                          'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200'
                        }`}>
                          {article.category}
                        </span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">
                        {article.date}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        {article.featured ? (
                          <span class="text-yellow-500">â­</span>
                        ) : (
                          <span class="text-gray-400">â—‹</span>
                        )}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <div class="flex gap-2">
                          <button 
                            class="edit-btn"
                            data-article={JSON.stringify(article)}
                            class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300"
                          >
                            ç¼–è¾‘
                          </button>
                          <form method="POST" class="inline delete-form">
                            <input type="hidden" name="action" value="delete" />
                            <input type="hidden" name="id" value={article.id} />
                            <button 
                              type="submit"
                              class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"
                            >
                              åˆ é™¤
                            </button>
                          </form>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const showBtn = document.getElementById('showCreateBtn');
      showBtn?.addEventListener('click', () => showCreateForm());

      document.querySelectorAll('.edit-btn').forEach((el) => {
        el.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLElement;
          const json = target.getAttribute('data-article');
          if (json) {
            try {
              const article = JSON.parse(json);
              editArticle(article);
            } catch {}
          }
        });
      });

      document.querySelectorAll('.delete-form').forEach((formEl) => {
        formEl.addEventListener('submit', (e) => {
          if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿ')) {
            e.preventDefault();
          }
        });
      });
    });
    function showCreateForm() {
      document.getElementById('articleForm')?.classList.remove('hidden');
      const formTitle = document.getElementById('formTitle');
      if (formTitle) formTitle.textContent = 'æ–°å»ºæ–‡ç« ';
      const formAction = document.getElementById('formAction') as HTMLInputElement | null;
      if (formAction) formAction.value = 'create';
      const articleId = document.getElementById('articleId') as HTMLInputElement | null;
      if (articleId) articleId.value = '';
      resetForm();
    }
    
    function hideForm() {
      document.getElementById('articleForm')?.classList.add('hidden');
      resetForm();
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      const cancelBtn = document.getElementById('cancelArticleBtn');
      cancelBtn?.addEventListener('click', () => hideForm());
    });
    
    function resetForm() {
      const form = document.querySelector('#articleForm form') as HTMLFormElement;
      form.reset();
      // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
      const today = new Date().toISOString().split('T')[0];
      (document.getElementById('date') as HTMLInputElement).value = today;
    }
    
    function editArticle(article: any) {
      document.getElementById('articleForm')?.classList.remove('hidden');
      const formTitle = document.getElementById('formTitle');
      if (formTitle) formTitle.textContent = 'ç¼–è¾‘æ–‡ç« ';
      const formAction = document.getElementById('formAction') as HTMLInputElement | null;
      if (formAction) formAction.value = 'update';
      const articleId = document.getElementById('articleId') as HTMLInputElement | null;
      if (articleId) articleId.value = String(article.id);

      const title = document.getElementById('title') as HTMLInputElement | null;
      if (title) title.value = article.title;
      const summary = document.getElementById('summary') as HTMLTextAreaElement | null;
      if (summary) summary.value = article.summary;
      const content = document.getElementById('content') as HTMLTextAreaElement | null;
      if (content) content.value = article.content;
      const category = document.getElementById('category') as HTMLSelectElement | null;
      if (category) category.value = article.category;
      const tags = document.getElementById('tags') as HTMLInputElement | null;
      if (tags) tags.value = article.tags.join(', ');
      const date = document.getElementById('date') as HTMLInputElement | null;
      if (date) date.value = article.date;
      const readTime = document.getElementById('readTime') as HTMLInputElement | null;
      if (readTime) readTime.value = article.readTime;
      const featured = document.getElementById('featured') as HTMLSelectElement | null;
      if (featured) featured.value = String(article.featured);
      const image = document.getElementById('image') as HTMLInputElement | null;
      if (image) image.value = article.image;
      const authorName = document.getElementById('authorName') as HTMLInputElement | null;
      if (authorName) authorName.value = article.author.name;
      const authorAvatar = document.getElementById('authorAvatar') as HTMLInputElement | null;
      if (authorAvatar) authorAvatar.value = article.author.avatar;
    }
    
    // è®¾ç½®é»˜è®¤æ—¥æœŸ
    document.addEventListener('DOMContentLoaded', function() {
      const today = new Date().toISOString().split('T')[0];
      const dateInput = document.getElementById('date') as HTMLInputElement;
      if (dateInput && !dateInput.value) {
        dateInput.value = today;
      }
    });
  </script>
</Layout>